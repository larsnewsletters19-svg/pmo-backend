<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <title>AI PMO Generator v7.0 - Cloud Edition</title>
    
    <!-- Prevent service worker caching issues -->
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(function(registrations) {
                for(let registration of registrations) {
                    registration.unregister();
                }
            });
        }
    </script>
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        
        .glass-dark {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        
        .gradient-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .btn-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
        }
        
        .btn-gradient:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }
        
        .card {
            transition: all 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        textarea:focus, input:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .tab-active {
            background: white;
            color: #667eea;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .tab-inactive {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }
        
        .tab-inactive:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(102, 126, 234, 0.5);
            border-radius: 5px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(102, 126, 234, 0.7);
        }
        
        /* Loading animation */
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid white;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Toast notification */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            z-index: 9999;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .toast-success {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .toast-error {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        
        .toast-info {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;

        // ============================================
        // SUPABASE SETUP
        // ============================================
        const SUPABASE_URL = 'https://zcdjwtyxehfrkyhnpekq.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpjZGp3dHl4ZWhmcmt5aG5wZWtxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxOTEyNDYsImV4cCI6MjA4MDc2NzI0Nn0.Pg0etjmcDrgE30R0ERXpESxfAGyxhR2cqMnCGArEn9o';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ============================================
        // GDPR ANONYMIZATION UTILITIES
        // ============================================
        const sensitivePatterns = {
            email: /\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/g,
            phone: /\b(\+46|0)[\s-]?[0-9]{2,3}[\s-]?[0-9]{3}[\s-]?[0-9]{2,3}\b/g,
            ssn: /\b\d{6}[-\s]?\d{4}\b/g, // Swedish personnummer
            ipv4: /\b(?:\d{1,3}\.){3}\d{1,3}\b/g,
            creditCard: /\b\d{4}[\s-]?\d{4}[\s-]?\d{4}[\s-]?\d{4}\b/g,
        };

        function detectSensitiveData(text) {
            const findings = [];
            for (const [type, pattern] of Object.entries(sensitivePatterns)) {
                const matches = [...text.matchAll(pattern)];
                matches.forEach(match => {
                    findings.push({
                        type,
                        value: match[0],
                        index: match.index
                    });
                });
            }
            return findings;
        }

        function anonymizeText(text, anonymizationMap = {}) {
            let anonymized = text;
            
            // Apply existing anonymization map
            for (const [original, replacement] of Object.entries(anonymizationMap)) {
                anonymized = anonymized.replaceAll(original, replacement);
            }
            
            // Detect and anonymize new sensitive data
            const newMap = {};
            
            for (const [type, pattern] of Object.entries(sensitivePatterns)) {
                const matches = [...anonymized.matchAll(pattern)];
                matches.forEach((match, index) => {
                    const original = match[0];
                    if (!anonymizationMap[original]) {
                        const replacement = `[${type.toUpperCase()}_${index + 1}]`;
                        newMap[original] = replacement;
                        anonymized = anonymized.replaceAll(original, replacement);
                    }
                });
            }
            
            return { anonymized, newMap };
        }

        // ============================================
        // TOAST NOTIFICATIONS
        // ============================================
        function ToastContainer({ toasts, removeToast }) {
            return (
                <div style={{ position: 'fixed', top: 20, right: 20, zIndex: 9999 }}>
                    {toasts.map(toast => (
                        <div key={toast.id} className={`toast toast-${toast.type}`}>
                            <div className="flex items-center justify-between">
                                <span>{toast.message}</span>
                                <button 
                                    onClick={() => removeToast(toast.id)}
                                    className="ml-4 text-white hover:text-gray-200"
                                >
                                    ‚úï
                                </button>
                            </div>
                        </div>
                    ))}
                </div>
            );
        }

        // ============================================
        // AUTH COMPONENT
        // ============================================
        function AuthScreen({ onLogin }) {
            const [isLogin, setIsLogin] = useState(true);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');

                try {
                    let result;
                    if (isLogin) {
                        result = await supabase.auth.signInWithPassword({ email, password });
                    } else {
                        result = await supabase.auth.signUp({ email, password });
                    }

                    if (result.error) throw result.error;

                    if (!isLogin) {
                        setError('Konto skapat! Kolla din e-post f√∂r att verifiera kontot.');
                    } else {
                        onLogin(result.data.user);
                    }
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center p-4">
                    <div className="glass rounded-2xl p-8 w-full max-w-md fade-in">
                        <div className="text-center mb-8">
                            <h1 className="text-4xl font-bold gradient-text mb-2">
                                AI PMO Generator
                            </h1>
                            <p className="text-gray-600">v7.0 - Cloud Edition</p>
                        </div>

                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">
                                    E-post
                                </label>
                                <input
                                    type="email"
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                    required
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">
                                    L√∂senord
                                </label>
                                <input
                                    type="password"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                    required
                                />
                            </div>

                            {error && (
                                <div className="p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm">
                                    {error}
                                </div>
                            )}

                            <button
                                type="submit"
                                disabled={loading}
                                className="w-full btn-gradient text-white py-3 rounded-lg font-medium"
                            >
                                {loading ? (
                                    <div className="flex items-center justify-center">
                                        <div className="spinner" style={{ width: 20, height: 20, borderWidth: 2 }}></div>
                                    </div>
                                ) : (
                                    isLogin ? 'Logga in' : 'Skapa konto'
                                )}
                            </button>
                        </form>

                        <div className="mt-4 text-center">
                            <button
                                onClick={() => setIsLogin(!isLogin)}
                                className="text-sm text-gray-600 hover:text-gray-800"
                            >
                                {isLogin ? 'Inget konto? Skapa ett h√§r' : 'Har redan konto? Logga in'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // ============================================
        // PROJECT SELECTOR
        // ============================================
        function ProjectSelector({ user, onProjectSelected, onLogout }) {
            const [projects, setProjects] = useState([]);
            const [loading, setLoading] = useState(true);
            const [newProjectName, setNewProjectName] = useState('');
            const [showNewProject, setShowNewProject] = useState(false);

            useEffect(() => {
                loadProjects();
            }, []);

            const loadProjects = async () => {
                try {
                    const { data, error } = await supabase
                        .from('projects')
                        .select('*')
                        .order('created_at', { ascending: false });

                    if (error) throw error;
                    setProjects(data || []);
                } catch (err) {
                    console.error('Error loading projects:', err);
                } finally {
                    setLoading(false);
                }
            };

            const createProject = async () => {
                if (!newProjectName.trim()) return;

                try {
                    const { data, error } = await supabase
                        .from('projects')
                        .insert([{ name: newProjectName, user_id: user.id }])
                        .select()
                        .single();

                    if (error) throw error;

                    setProjects([data, ...projects]);
                    setNewProjectName('');
                    setShowNewProject(false);
                } catch (err) {
                    console.error('Error creating project:', err);
                    alert('Kunde inte skapa projekt: ' + err.message);
                }
            };

            if (loading) {
                return (
                    <div className="min-h-screen flex items-center justify-center">
                        <div className="spinner"></div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen p-4 md:p-8">
                    <div className="max-w-4xl mx-auto">
                        <div className="glass rounded-2xl p-6 md:p-8 fade-in">
                            <div className="flex justify-between items-center mb-6">
                                <div>
                                    <h1 className="text-3xl font-bold gradient-text">Mina Projekt</h1>
                                    <p className="text-gray-600 mt-1">{user.email}</p>
                                </div>
                                <button
                                    onClick={onLogout}
                                    className="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg"
                                >
                                    Logga ut
                                </button>
                            </div>

                            {showNewProject ? (
                                <div className="mb-6 p-4 bg-gray-50 rounded-lg">
                                    <h3 className="font-semibold mb-3">Skapa nytt projekt</h3>
                                    <div className="flex gap-2">
                                        <input
                                            type="text"
                                            value={newProjectName}
                                            onChange={(e) => setNewProjectName(e.target.value)}
                                            placeholder="Projektnamn..."
                                            className="flex-1 px-4 py-2 border border-gray-300 rounded-lg"
                                            onKeyPress={(e) => e.key === 'Enter' && createProject()}
                                        />
                                        <button
                                            onClick={createProject}
                                            className="btn-gradient text-white px-6 py-2 rounded-lg"
                                        >
                                            Skapa
                                        </button>
                                        <button
                                            onClick={() => {
                                                setShowNewProject(false);
                                                setNewProjectName('');
                                            }}
                                            className="px-4 py-2 bg-gray-200 rounded-lg"
                                        >
                                            Avbryt
                                        </button>
                                    </div>
                                </div>
                            ) : (
                                <button
                                    onClick={() => setShowNewProject(true)}
                                    className="w-full mb-6 p-4 border-2 border-dashed border-gray-300 rounded-lg hover:border-gray-400 hover:bg-gray-50 transition-all"
                                >
                                    <span className="text-gray-600 font-medium">+ Skapa nytt projekt</span>
                                </button>
                            )}

                            {projects.length === 0 ? (
                                <div className="text-center py-12 text-gray-500">
                                    <p>Inga projekt √§n. Skapa ditt f√∂rsta projekt f√∂r att komma ig√•ng!</p>
                                </div>
                            ) : (
                                <div className="grid gap-4">
                                    {projects.map(project => (
                                        <div
                                            key={project.id}
                                            onClick={() => onProjectSelected(project)}
                                            className="card glass-dark p-6 rounded-xl cursor-pointer"
                                        >
                                            <h3 className="text-xl font-semibold text-white mb-2">
                                                {project.name}
                                            </h3>
                                            <p className="text-gray-300 text-sm">
                                                Skapad: {new Date(project.created_at).toLocaleDateString('sv-SE')}
                                            </p>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // ============================================
        // MAIN APP COMPONENT
        // ============================================
        function App() {
            const [user, setUser] = useState(null);
            const [currentProject, setCurrentProject] = useState(null);
            const [loading, setLoading] = useState(true);
            const [toasts, setToasts] = useState([]);

            // Check authentication on mount
            useEffect(() => {
                checkUser();
                
                const { data: authListener } = supabase.auth.onAuthStateChange((event, session) => {
                    setUser(session?.user || null);
                });

                return () => {
                    authListener?.subscription?.unsubscribe();
                };
            }, []);

            const checkUser = async () => {
                try {
                    const { data: { session } } = await supabase.auth.getSession();
                    setUser(session?.user || null);
                } catch (err) {
                    console.error('Error checking auth:', err);
                } finally {
                    setLoading(false);
                }
            };

            const handleLogout = async () => {
                await supabase.auth.signOut();
                setUser(null);
                setCurrentProject(null);
            };

            const addToast = (message, type = 'success') => {
                const id = Date.now();
                setToasts(prev => [...prev, { id, message, type }]);
                setTimeout(() => removeToast(id), 5000);
            };

            const removeToast = (id) => {
                setToasts(prev => prev.filter(t => t.id !== id));
            };

            if (loading) {
                return (
                    <div className="min-h-screen flex items-center justify-center">
                        <div className="spinner"></div>
                    </div>
                );
            }

            if (!user) {
                return <AuthScreen onLogin={setUser} />;
            }

            if (!currentProject) {
                return (
                    <>
                        <ProjectSelector 
                            user={user} 
                            onProjectSelected={setCurrentProject}
                            onLogout={handleLogout}
                        />
                        <ToastContainer toasts={toasts} removeToast={removeToast} />
                    </>
                );
            }

            return (
                <>
                    <WorkspaceScreen 
                        user={user}
                        project={currentProject}
                        onBackToProjects={() => setCurrentProject(null)}
                        onLogout={handleLogout}
                        addToast={addToast}
                    />
                    <ToastContainer toasts={toasts} removeToast={removeToast} />
                </>
            );
        }

        // ============================================
        // WORKSPACE SCREEN (Main functionality from v6.0)
        // ============================================
        function WorkspaceScreen({ user, project, onBackToProjects, onLogout, addToast }) {
            const [activeTab, setActiveTab] = useState('rawdata');
            const [rawData, setRawData] = useState('');
            const [apiKey, setApiKey] = useState('');
            const [language, setLanguage] = useState('swedish');
            const [generating, setGenerating] = useState(false);
            const [documents, setDocuments] = useState({});
            const [anonymizationEnabled, setAnonymizationEnabled] = useState(true);
            const [anonymizationMap, setAnonymizationMap] = useState({});
            const [sensitiveDataCount, setSensitiveDataCount] = useState(0);

            // Load project data on mount
            useEffect(() => {
                loadProjectData();
            }, [project.id]);

            // Auto-save when rawData changes
            useEffect(() => {
                const timer = setTimeout(() => {
                    if (rawData) saveRawData();
                }, 2000); // Auto-save after 2 seconds of no typing
                
                return () => clearTimeout(timer);
            }, [rawData]);

            // Check for sensitive data
            useEffect(() => {
                if (rawData) {
                    const findings = detectSensitiveData(rawData);
                    setSensitiveDataCount(findings.length);
                }
            }, [rawData]);

            const loadProjectData = async () => {
                try {
                    // Load raw data entries
                    const { data: rawDataEntries, error: rawError } = await supabase
                        .from('raw_data_entries')
                        .select('*')
                        .eq('project_id', project.id)
                        .order('entry_date', { ascending: false });

                    if (rawError) throw rawError;

                    // Combine raw data entries
                    const combinedRaw = rawDataEntries
                        ?.map(entry => {
                            let text = '';
                            if (entry.entry_date) {
                                text += `=${entry.entry_date}=\n`;
                            }
                            if (entry.is_meeting) {
                                text += '=M√ñTE=\n';
                            }
                            text += entry.content + '\n===\n\n';
                            return text;
                        })
                        .join('') || '';

                    setRawData(combinedRaw);

                    // Load documents
                    const { data: docs, error: docsError } = await supabase
                        .from('documents')
                        .select('*')
                        .eq('project_id', project.id);

                    if (docsError) throw docsError;

                    const docsObj = {};
                    docs?.forEach(doc => {
                        docsObj[doc.doc_type] = doc.content;
                    });
                    setDocuments(docsObj);

                    // Load anonymization map
                    const { data: anonMap, error: anonError } = await supabase
                        .from('anonymization_maps')
                        .select('*')
                        .eq('project_id', project.id);

                    if (anonError) throw anonError;

                    const mapObj = {};
                    anonMap?.forEach(item => {
                        mapObj[item.original_value] = item.anonymized_value;
                    });
                    setAnonymizationMap(mapObj);

                } catch (err) {
                    console.error('Error loading project data:', err);
                    addToast('Kunde inte ladda projektdata', 'error');
                }
            };

            const saveRawData = async () => {
                try {
                    // Parse raw data into entries
                    const entries = parseRawDataEntries(rawData);
                    
                    // Delete old entries
                    await supabase
                        .from('raw_data_entries')
                        .delete()
                        .eq('project_id', project.id);

                    // Insert new entries
                    if (entries.length > 0) {
                        const { error } = await supabase
                            .from('raw_data_entries')
                            .insert(entries.map(entry => ({
                                project_id: project.id,
                                entry_date: entry.date,
                                is_meeting: entry.isMeeting,
                                content: entry.content
                            })));

                        if (error) throw error;
                    }
                } catch (err) {
                    console.error('Error saving raw data:', err);
                }
            };

            const parseRawDataEntries = (text) => {
                const entries = [];
                const sections = text.split('===').filter(s => s.trim());
                
                sections.forEach(section => {
                    const lines = section.trim().split('\n');
                    let date = null;
                    let isMeeting = false;
                    let contentLines = [];
                    
                    for (const line of lines) {
                        if (line.match(/^=\d{4}-\d{2}-\d{2}=$/)) {
                            date = line.replace(/=/g, '');
                        } else if (line === '=M√ñTE=') {
                            isMeeting = true;
                        } else {
                            contentLines.push(line);
                        }
                    }
                    
                    const content = contentLines.join('\n').trim();
                    if (content) {
                        entries.push({ date, isMeeting, content });
                    }
                });
                
                return entries;
            };

            const saveAnonymizationMap = async (newMap) => {
                try {
                    const entries = Object.entries(newMap).map(([original, anonymized]) => ({
                        project_id: project.id,
                        original_value: original,
                        anonymized_value: anonymized
                    }));

                    if (entries.length > 0) {
                        await supabase
                            .from('anonymization_maps')
                            .upsert(entries, { 
                                onConflict: 'project_id,original_value',
                                ignoreDuplicates: false 
                            });
                    }
                } catch (err) {
                    console.error('Error saving anonymization map:', err);
                }
            };

            const insertDateTag = (daysAgo = 0) => {
                const date = new Date();
                date.setDate(date.getDate() - daysAgo);
                const dateStr = date.toISOString().split('T')[0];
                const tag = `=${dateStr}=\n`;
                
                const textarea = document.querySelector('textarea');
                const start = textarea.selectionStart;
                const end = textarea.selectionEnd;
                const newText = rawData.substring(0, start) + tag + rawData.substring(end);
                setRawData(newText);
                
                setTimeout(() => {
                    textarea.focus();
                    textarea.setSelectionRange(start + tag.length, start + tag.length);
                }, 0);
            };

            const insertMeetingTag = () => {
                const tag = '=M√ñTE=\n';
                const textarea = document.querySelector('textarea');
                const start = textarea.selectionStart;
                const end = textarea.selectionEnd;
                const newText = rawData.substring(0, start) + tag + rawData.substring(end);
                setRawData(newText);
                
                setTimeout(() => {
                    textarea.focus();
                    textarea.setSelectionRange(start + tag.length, start + tag.length);
                }, 0);
            };

            const insertEndTag = () => {
                const tag = '\n===\n';
                const textarea = document.querySelector('textarea');
                const start = textarea.selectionStart;
                const end = textarea.selectionEnd;
                const newText = rawData.substring(0, start) + tag + rawData.substring(end);
                setRawData(newText);
                
                setTimeout(() => {
                    textarea.focus();
                    textarea.setSelectionRange(start + tag.length, start + tag.length);
                }, 0);
            };

            const openDatePicker = () => {
                const dateInput = document.createElement('input');
                dateInput.type = 'date';
                dateInput.style.position = 'absolute';
                dateInput.style.opacity = '0';
                document.body.appendChild(dateInput);
                
                dateInput.addEventListener('change', (e) => {
                    if (e.target.value) {
                        const tag = `=${e.target.value}=\n`;
                        const textarea = document.querySelector('textarea');
                        const start = textarea.selectionStart;
                        const newText = rawData.substring(0, start) + tag + rawData.substring(start);
                        setRawData(newText);
                        
                        setTimeout(() => {
                            textarea.focus();
                            textarea.setSelectionRange(start + tag.length, start + tag.length);
                        }, 0);
                    }
                    document.body.removeChild(dateInput);
                });
                
                dateInput.showPicker();
            };

            const generateDocument = async (docType) => {
                if (!apiKey) {
                    addToast('V√§nligen ange din Claude API-nyckel f√∂rst', 'error');
                    return;
                }

                setGenerating(true);
                addToast(`Genererar ${getDocTypeName(docType)}...`, 'info');

                try {
                    let dataToUse = rawData;
                    let newAnonymizationMap = { ...anonymizationMap };

                    // Apply anonymization if enabled
                    if (anonymizationEnabled && sensitiveDataCount > 0) {
                        const result = anonymizeText(rawData, anonymizationMap);
                        dataToUse = result.anonymized;
                        newAnonymizationMap = { ...anonymizationMap, ...result.newMap };
                        
                        if (Object.keys(result.newMap).length > 0) {
                            setAnonymizationMap(newAnonymizationMap);
                            await saveAnonymizationMap(result.newMap);
                            addToast('K√§nslig data anonymiserad', 'info');
                        }
                    }

                    const prompt = buildPrompt(docType, dataToUse, language);

                    const response = await fetch('https://api.anthropic.com/v1/messages', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-api-key': apiKey,
                            'anthropic-version': '2023-06-01'
                        },
                        body: JSON.stringify({
                            model: 'claude-sonnet-4-20250514',
                            max_tokens: 4096,
                            messages: [{
                                role: 'user',
                                content: prompt
                            }]
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`API error: ${response.status}`);
                    }

                    const data = await response.json();
                    const content = data.content[0].text;

                    // Save document to Supabase
                    const { error } = await supabase
                        .from('documents')
                        .upsert({
                            project_id: project.id,
                            doc_type: docType,
                            content: content,
                            language: language
                        }, {
                            onConflict: 'project_id,doc_type'
                        });

                    if (error) throw error;

                    setDocuments(prev => ({ ...prev, [docType]: content }));
                    addToast(`${getDocTypeName(docType)} genererad!`, 'success');

                } catch (err) {
                    console.error('Error generating document:', err);
                    addToast('Fel vid generering: ' + err.message, 'error');
                } finally {
                    setGenerating(false);
                }
            };

            const getDocTypeName = (docType) => {
                const names = {
                    weekly: 'Veckorapport',
                    meeting: 'M√∂tesammanfattning',
                    risk: 'Risklogg',
                    action: '√Ötg√§rdslogg',
                    stories: 'User Stories',
                    steering: 'Styrgruppresentation',
                    timeline: 'Milstolpar & Tidslinje',
                    trends: 'Trender & Analys',
                    report: 'Projektrapport'
                };
                return names[docType] || docType;
            };

            const buildPrompt = (docType, data, lang) => {
                // Simplified prompt building - same logic as v6.0
                const isSwedish = lang === 'swedish';
                
                const prompts = {
                    weekly: isSwedish 
                        ? `Skapa en veckorapport baserat p√• denna projektdata:\n\n${data}\n\nFormatera som en strukturerad veckorapport med avsnitt f√∂r: Status, Framsteg, Utmaningar, N√§sta steg.`
                        : `Create a weekly report based on this project data:\n\n${data}\n\nFormat as a structured weekly report with sections: Status, Progress, Challenges, Next Steps.`,
                    
                    meeting: isSwedish
                        ? `Skapa en m√∂tesammanfattning fr√•n denna m√∂tesdata:\n\n${data}\n\nInkludera: Deltagare, Diskussionspunkter, Beslut, √Ötg√§rder.`
                        : `Create a meeting summary from this meeting data:\n\n${data}\n\nInclude: Attendees, Discussion Points, Decisions, Actions.`,
                    
                    risk: isSwedish
                        ? `Skapa en risklogg fr√•n denna data:\n\n${data}\n\nIdentifiera och lista risker med: Beskrivning, Sannolikhet, P√•verkan, √Ötg√§rd.`
                        : `Create a risk log from this data:\n\n${data}\n\nIdentify and list risks with: Description, Likelihood, Impact, Mitigation.`,
                    
                    action: isSwedish
                        ? `Skapa en √•tg√§rdslogg fr√•n denna data:\n\n${data}\n\nLista √•tg√§rder med: Beskrivning, Ansvarig, Deadline, Status.`
                        : `Create an action log from this data:\n\n${data}\n\nList actions with: Description, Owner, Deadline, Status.`,
                    
                    stories: isSwedish
                        ? `Skapa user stories fr√•n denna data:\n\n${data}\n\nFormat: Som [roll] vill jag [funktion] s√• att [nytta].`
                        : `Create user stories from this data:\n\n${data}\n\nFormat: As a [role] I want [feature] so that [benefit].`,
                    
                    steering: isSwedish
                        ? `Skapa en styrgruppspresentation fr√•n denna data:\n\n${data}\n\nInkludera: Sammanfattning, Status, Viktiga beslut, N√§sta steg.`
                        : `Create a steering committee presentation from this data:\n\n${data}\n\nInclude: Summary, Status, Key Decisions, Next Steps.`,
                    
                    timeline: isSwedish
                        ? `Skapa milstolpar och tidslinje fr√•n denna data:\n\n${data}\n\nLista milstolpar med datum och status.`
                        : `Create milestones and timeline from this data:\n\n${data}\n\nList milestones with dates and status.`,
                    
                    trends: isSwedish
                        ? `Analysera trender fr√•n denna data:\n\n${data}\n\nIdentifiera m√∂nster, trender och utveckling √∂ver tid.`
                        : `Analyze trends from this data:\n\n${data}\n\nIdentify patterns, trends and development over time.`,
                    
                    report: isSwedish
                        ? `Skapa en omfattande projektrapport fr√•n denna data:\n\n${data}\n\nInkludera alla relevanta aspekter av projektet.`
                        : `Create a comprehensive project report from this data:\n\n${data}\n\nInclude all relevant aspects of the project.`
                };

                return prompts[docType] || data;
            };

            const copyDocument = (docType) => {
                const content = documents[docType];
                if (content) {
                    navigator.clipboard.writeText(content);
                    addToast('Kopierat till urklipp!', 'success');
                }
            };

            const downloadDocument = (docType) => {
                const content = documents[docType];
                if (content) {
                    const blob = new Blob([content], { type: 'text/plain' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${project.name}_${docType}_${new Date().toISOString().split('T')[0]}.txt`;
                    a.click();
                    URL.revokeObjectURL(url);
                }
            };

            return (
                <div className="min-h-screen p-2 md:p-4">
                    <div className="max-w-7xl mx-auto">
                        {/* Header */}
                        <div className="glass rounded-2xl p-4 md:p-6 mb-4 fade-in">
                            <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                                <div>
                                    <h1 className="text-2xl md:text-3xl font-bold gradient-text">
                                        {project.name}
                                    </h1>
                                    <p className="text-gray-600 text-sm mt-1">{user.email}</p>
                                </div>
                                <div className="flex gap-2 w-full md:w-auto">
                                    <button
                                        onClick={onBackToProjects}
                                        className="flex-1 md:flex-none px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg"
                                    >
                                        ‚Üê Projekt
                                    </button>
                                    <button
                                        onClick={onLogout}
                                        className="flex-1 md:flex-none px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg"
                                    >
                                        Logga ut
                                    </button>
                                </div>
                            </div>

                            {/* Settings */}
                            <div className="mt-4 pt-4 border-t border-gray-200">
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">
                                            Claude API-nyckel
                                        </label>
                                        <input
                                            type="password"
                                            value={apiKey}
                                            onChange={(e) => setApiKey(e.target.value)}
                                            placeholder="sk-ant-..."
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">
                                            Spr√•k
                                        </label>
                                        <select
                                            value={language}
                                            onChange={(e) => setLanguage(e.target.value)}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"
                                        >
                                            <option value="swedish">Svenska</option>
                                            <option value="english">English</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">
                                            GDPR Anonymisering
                                        </label>
                                        <div className="flex items-center h-10">
                                            <input
                                                type="checkbox"
                                                checked={anonymizationEnabled}
                                                onChange={(e) => setAnonymizationEnabled(e.target.checked)}
                                                className="mr-2"
                                            />
                                            <span className="text-sm">
                                                Aktiverad {sensitiveDataCount > 0 && `(${sensitiveDataCount} k√§nsliga data)`}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Tabs */}
                        <div className="flex gap-2 mb-4 overflow-x-auto pb-2">
                            <button
                                onClick={() => setActiveTab('rawdata')}
                                className={`px-4 py-2 rounded-lg font-medium whitespace-nowrap ${
                                    activeTab === 'rawdata' ? 'tab-active' : 'tab-inactive'
                                }`}
                            >
                                üìù R√•data
                            </button>
                            <button
                                onClick={() => setActiveTab('documents')}
                                className={`px-4 py-2 rounded-lg font-medium whitespace-nowrap ${
                                    activeTab === 'documents' ? 'tab-active' : 'tab-inactive'
                                }`}
                            >
                                üìÑ Dokument
                            </button>
                        </div>

                        {/* Content */}
                        {activeTab === 'rawdata' && (
                            <div className="glass rounded-2xl p-4 md:p-6 fade-in">
                                {/* Quick Insert Buttons */}
                                <div className="mb-4 flex flex-wrap gap-2">
                                    <button
                                        onClick={() => insertDateTag(0)}
                                        className="px-3 py-1 bg-blue-100 hover:bg-blue-200 rounded text-sm"
                                    >
                                        [Idag]
                                    </button>
                                    <button
                                        onClick={() => insertDateTag(1)}
                                        className="px-3 py-1 bg-blue-100 hover:bg-blue-200 rounded text-sm"
                                    >
                                        [Ig√•r]
                                    </button>
                                    <button
                                        onClick={openDatePicker}
                                        className="px-3 py-1 bg-blue-100 hover:bg-blue-200 rounded text-sm"
                                    >
                                        [V√§lj datum...]
                                    </button>
                                    <button
                                        onClick={insertMeetingTag}
                                        className="px-3 py-1 bg-green-100 hover:bg-green-200 rounded text-sm"
                                    >
                                        [Markera som m√∂te]
                                    </button>
                                    <button
                                        onClick={insertEndTag}
                                        className="px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded text-sm"
                                    >
                                        [Avsluta sektion]
                                    </button>
                                </div>

                                <textarea
                                    value={rawData}
                                    onChange={(e) => setRawData(e.target.value)}
                                    placeholder="Skriv din projektdata h√§r...&#10;&#10;Anv√§nd:&#10;=YYYY-MM-DD= f√∂r datum&#10;=M√ñTE= f√∂r m√∂ten&#10;=== f√∂r att avsluta en sektion"
                                    className="w-full h-96 px-4 py-3 border border-gray-300 rounded-lg resize-none font-mono text-sm"
                                />

                                <div className="mt-2 text-sm text-gray-600">
                                    Auto-sparar... {sensitiveDataCount > 0 && (
                                        <span className="text-orange-600 font-medium">
                                            ‚ö†Ô∏è {sensitiveDataCount} k√§nsliga data hittade
                                        </span>
                                    )}
                                </div>
                            </div>
                        )}

                        {activeTab === 'documents' && (
                            <div className="glass rounded-2xl p-4 md:p-6 fade-in">
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                                    {['weekly', 'meeting', 'risk', 'action', 'stories', 'steering', 'timeline', 'trends', 'report'].map(docType => (
                                        <button
                                            key={docType}
                                            onClick={() => generateDocument(docType)}
                                            disabled={generating}
                                            className="card glass-dark p-4 rounded-xl text-white hover:scale-105"
                                        >
                                            <h3 className="font-semibold mb-1">
                                                {getDocTypeName(docType)}
                                            </h3>
                                            {documents[docType] && (
                                                <span className="text-xs text-green-300">‚úì Genererad</span>
                                            )}
                                        </button>
                                    ))}
                                </div>

                                {/* Display generated documents */}
                                {Object.keys(documents).length > 0 && (
                                    <div className="space-y-4">
                                        {Object.entries(documents).map(([docType, content]) => (
                                            <div key={docType} className="border border-gray-200 rounded-lg p-4">
                                                <div className="flex justify-between items-center mb-2">
                                                    <h3 className="font-semibold">{getDocTypeName(docType)}</h3>
                                                    <div className="flex gap-2">
                                                        <button
                                                            onClick={() => copyDocument(docType)}
                                                            className="px-3 py-1 bg-blue-100 hover:bg-blue-200 rounded text-sm"
                                                        >
                                                            üìã Kopiera
                                                        </button>
                                                        <button
                                                            onClick={() => downloadDocument(docType)}
                                                            className="px-3 py-1 bg-green-100 hover:bg-green-200 rounded text-sm"
                                                        >
                                                            üíæ Ladda ner
                                                        </button>
                                                    </div>
                                                </div>
                                                <pre className="whitespace-pre-wrap text-sm bg-gray-50 p-3 rounded">
                                                    {content}
                                                </pre>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // ============================================
        // RENDER APP
        // ============================================
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>